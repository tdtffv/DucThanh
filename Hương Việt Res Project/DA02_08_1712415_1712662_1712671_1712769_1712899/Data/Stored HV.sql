USE HuongViet
GO

--Xem thực đơn của nhà hàng theo chi nhánh và ngày
CREATE PROC sp_XemThucDon
	@MACN int, 
	@Ngay date
AS
BEGIN TRAN
	SELECT M.MAMON,M.TENMON, L.TENLOAI, TD.SL_CONLAI, TD.SOLUONG FROM THUCDON TD, MONAN M, LOAIMON L
	WHERE TD.MAMON = M.MAMON AND M.MALOAI = L.MALOAI AND @MACN = TD.MACN and @Ngay = TD.NGAY
COMMIT TRAN
GO

--KHÁCH HÀNG ĐĂNG KÝ TÀI KHOẢN ONL 
CREATE PROC sp_THEMTHANHVIENonl
	@TENTV NVARCHAR(100),
	@MATKHAU VARCHAR(100),
	@CMND VARCHAR(20),
	@NGSINH DATE,
	@CHINHANHDK NVARCHAR(100),
	@DIACHI NVARCHAR(100),
	@EMAIL NVARCHAR(100)
AS
BEGIN
BEGIN TRAN
DECLARE @LOAITHE NVARCHAR(100) = N'Silver'
DECLARE @MATV INT = (SELECT MAX (MATV) FROM THANHVIEN) 
	BEGIN TRY
		IF (@MATV IS NULL)
		BEGIN
			SET @MATV = 1 
			INSERT INTO THANHVIEN VALUES (@MATV,@TENTV,@MATKHAU,@CMND,@NGSINH,@DIACHI,@CHINHANHDK,@EMAIL,0,@LOAITHE)
		END
		ELSE
		BEGIN
			SET @MATV = @MATV + 1
			INSERT INTO THANHVIEN VALUES (@MATV,@TENTV,@MATKHAU,@CMND,@NGSINH,@DIACHI,@CHINHANHDK,@EMAIL,0,@LOAITHE)
		END
		-- PRINT N'ĐĂNG KÝ THẺ THÀNH VIÊN THÀNH CÔNG!!!'
		COMMIT
	END TRY
	BEGIN CATCH
		ROLLBACK
	END CATCH
END
GO

--Đăng nhập
CREATE PROC SP_DangNhap
	@user int,
	@pass varchar(100)
AS
BEGIN TRAN
	BEGIN TRY
		IF NOT EXISTS(SELECT * FROM THANHVIEN WHERE @user = MATV)
		BEGIN
			PRINT'Không có tài khoản'
			ROLLBACK TRAN
			RETURN 0
		END
		IF NOT EXISTS(SELECT* FROM THANHVIEN WHERE @user = MATV AND @pass = MATKHAU)
		BEGIN
			PRINT'Không đúng mật khẩu'
			ROLLBACK TRAN
			RETURN 0
		END
	END TRY
	BEGIN CATCH
		PRINT'Lỗi đăng nhập'
		ROLLBACK TRAN
	END CATCH
	SELECT* FROM THANHVIEN WHERE @user = MATV AND @pass = MATKHAU
	PRINT'Đăng nhập thành công'
COMMIT TRAN
GO

--Cập nhật số phần ăn
CREATE PROC sp_CapNhatSoPhanAn
	@MACN int,
	@MAMON int,
	@NGAY date,
	@SOLUONG int,
	@SL_CON int
AS
BEGIN TRAN
	BEGIN TRY
		IF ((@MACN IS NULL) OR (@MAMON IS NULL) OR (@SOLUONG IS NULL) OR (@SL_CON IS NULL) OR (@NGAY IS NULL))
		BEGIN
			PRINT'thiếu thông tin'
			ROLLBACK TRAN
			RETURN 0
		END
		IF NOT EXISTS(SELECT * FROM THUCDON WHERE @MACN = MACN AND @MAMON = MAMON AND @NGAY = NGAY)
		BEGIN
			PRINT'Không có món ăn này trong thực đơn'
			ROLLBACK TRAN
			RETURN 0
		END
	END TRY
	BEGIN CATCH
		PRINT'Lỗi sửa thực đơn'
		ROLLBACK TRAN
	END CATCH
	UPDATE THUCDON SET SOLUONG = @SOLUONG, SL_CONLAI = @SL_CON WHERE @MACN = MACN AND @MAMON = MAMON AND NGAY = @NGAY
	PRINT'Sửa thành công'
COMMIT TRAN
GO

--Thống kê doanh thu theo ngày và chi nhánh
CREATE PROC sp_ThongKeTheoNgayCN @MACN int
AS
SELECT DH.NGAYDAT as NGAY, SUM(DH.THANHTIEN) AS DOANH_THU
FROM DONHANG DH
WHERE DH.MACN=@MACN
GROUP BY DH.NGAYDAT
ORDER BY NGAY DESC
GO

--Thống kê doanh thu theo tháng và chi nhánh
CREATE PROC sp_ThongKeTheoThangCN
	@MACN int
AS
SELECT MONTH(DH.NGAYDAT) AS THANG,YEAR(DH.NGAYDAT) as NAM, SUM(DH.THANHTIEN) AS DOANH_THU
FROM DONHANG DH
WHERE DH.MACN=@MACN
GROUP BY MONTH(DH.NGAYDAT),YEAR(DH.NGAYDAT)
ORDER BY THANG DESC, NAM DESC
GO

--Thống kê doanh thu theo năm và chi nhánh
CREATE PROC sp_ThongKeTheoNamCN
	@MACN int
AS
SELECT YEAR(DH.NGAYDAT) AS NAM, SUM(CAST(DH.THANHTIEN AS BIGINT)) AS DOANH_THU
FROM DONHANG DH
WHERE DH.MACN=@MACN
GROUP BY YEAR(DH.NGAYDAT)
ORDER BY NAM DESC
GO

--Thống kê theo món chi nhánh
CREATE PROC sp_ThongKeTheoMonCN
	@MACN int
AS
SELECT M.TENMON, SUM(CAST(CT.SL*M.GIATIEN AS BIGINT)) AS DOANH_THU
FROM CHITIETDONHANG CT, MONAN M,DONHANG DH
WHERE CT.MAMON = M.MAMON AND CT.MADH = DH.MADH AND DH.MACN=@MACN
GROUP BY M.TENMON
ORDER BY DOANH_THU DESC
GO

--Thống kê theo loại món chi nhánh
CREATE PROC sp_ThongKeTheoLoaiMonCN
	@MACN int
AS
SELECT L.TENLOAI, SUM(CAST(CT.SL*M.GIATIEN AS BIGINT)) AS DOANH_THU
FROM CHITIETDONHANG CT, MONAN M,LOAIMON L, DONHANG DH
WHERE CT.MAMON = M.MAMON AND M.MALOAI = L.MALOAI AND DH.MADH = CT.MADH AND DH.MACN=@MACN
GROUP BY L.TENLOAI
ORDER BY DOANH_THU DESC
GO

--Thống kê theo kênh đặt hàng chi nhánh
CREATE PROC sp_TheoKenhDatHangCN @MACN int
AS
SELECT DH.KENHDH, SUM(CAST(DH.THANHTIEN AS BIGINT)) AS DOANH_THU
FROM DONHANG DH
WHERE DH.MACN=@MACN
GROUP BY DH.KENHDH
ORDER BY DOANH_THU DESC
GO

--Thống kê theo loại khách hàng chi nhánh
CREATE PROC sp_ThongKeTheoLoaiKhachHangCN @MACN int
AS
SELECT SUM(CAST(DH.THANHTIEN AS BIGINT)) AS KHACHVANGLAI,
		(SELECT SUM(CAST(DH.THANHTIEN AS BIGINT))
		FROM DONHANG DH
		WHERE DH.MATV IS NULL AND DH.MACN=@MACN) THANHVIEN
FROM DONHANG DH 
WHERE DH.MATV IS NOT NULL AND DH.MACN=@MACN
GO

--Tỉ lệ hủy đơn theo kênh chi nhánh
CREATE PROC sp_TiLeHuyDonTheoKenh @MACN int
AS
BEGIN TRAN
	DECLARE @online int = (SELECT COUNT(*)
							FROM DONHANG DH
							WHERE DH.KENHDH = N'Online'AND DH.MACN=@MACN)
	IF(@online = 0) SET @online = 1
	DECLARE @dt int = (SELECT COUNT(*)
							FROM DONHANG DH
							WHERE DH.KENHDH = N'Điện thoại'AND DH.MACN=@MACN)
	IF(@dt = 0) SET @dt = 1
	DECLARE @tt int = (SELECT COUNT(*)
							FROM DONHANG DH
							WHERE DH.KENHDH = N'Trực tiếp'AND DH.MACN=@MACN)
	IF(@tt = 0) SET @tt = 1
	SELECT COUNT(*)*100/@online as TiLeHuyOnline, (SELECT COUNT(*)*100/@dt
											FROM DONHANG DH
											WHERE DH.KENHDH = N'Điện thoại'AND DH.MACN=@MACN AND DH.HUYDON = 1) TiLeHuyDienThoai
										,(SELECT COUNT(*)*100/@tt
											FROM DONHANG DH
											WHERE DH.KENHDH = N'Trực tiếp'AND DH.MACN=@MACN AND DH.HUYDON = 1) TiLeHuyTrucTiep
	FROM DONHANG DH
	WHERE DH.KENHDH = N'Online'AND DH.MACN=@MACN AND DH.HUYDON = 1
commit tran
GO

--Tỉ lệ hủy đơn theo loại KH chi nhánh
CREATE PROC sp_TiLeHuyDonTheoLoaiKH @MACN int
AS
BEGIN TRAN
	DECLARE @khach int = (SELECT COUNT(*)
							FROM DONHANG DH
							WHERE DH.MATV IS NULL AND DH.MACN=@MACN)
	IF(@khach = 0) SET @khach = 1
	DECLARE @thanhvien int = (SELECT COUNT(*)
								FROM DONHANG DH
								WHERE DH.MATV IS NOT NULL AND DH.MACN=@MACN)
	IF(@thanhvien = 0) SET @thanhvien = 1
	SELECT COUNT(*)*100/@khach as TiLeHuyKhachVangLai, (SELECT COUNT(*)*100/@thanhvien
														FROM DONHANG DH
														WHERE DH.MATV IS NOT NULL AND DH.MACN=@MACN AND DH.HUYDON = 1) TiLeHuyThanhVien
	FROM DONHANG DH
	WHERE DH.MATV IS NULL AND DH.MACN=@MACN AND DH.HUYDON = 1
commit tran
GO

--Thêm thành viên
CREATE PROC sp_Khach
	@tentv nvarchar(100),
	@cmnd varchar(20),
	@ngay_sinh date,
	@dia_chi nvarchar(100),
	@chinhanhdk int,
	@email nvarchar(100),
	@pass varchar(100)
AS
BEGIN TRAN
	BEGIN TRY
		IF((@tentv IS NULL) OR (@cmnd IS NULL) OR (@ngay_sinh IS NULL) OR (@dia_chi IS NULL) OR (@chinhanhdk IS NULL) OR (@email IS NULL) OR (@pass IS NULL))
		BEGIN
			PRINT('lỗi thiếu thông tin')
			rollback tran
			return
		END
		IF(EXISTS(SELECT*FROM THANHVIEN WHERE @cmnd = CMND))
		BEGIN
			PRINT'Đã có thành viên này'
			rollback tran
			return 
		END
		IF(NOT EXISTS(SELECT*FROM CHINHANH WHERE @chinhanhdk = MACN))
		BEGIN
			PRINT'Không có chi nhánh này'
			rollback tran
			return 
		END
	END TRY 
	BEGIN CATCH
		PRINT'Lỗi thêm khách'
		rollback tran
	END CATCH
	DECLARE @MATV int
	SET @MATV = (SELECT MATV FROM THANHVIEN WHERE MATV >= ALL(SELECT MATV FROM THANHVIEN)) + 1
	IF(@MATV IS NULL)
		SET @MATV = 1
	DECLARE @diem_tich_luy int
	DECLARE @the nvarchar(100)
	SET @the = N'Silver'
	SET @diem_tich_luy = 0
	INSERT INTO THANHVIEN VALUES(@MATV,@tentv,@pass,@cmnd,@ngay_sinh,@dia_chi,@chinhanhdk,@email,@diem_tich_luy,@the)
	print'thêm thành công'
commit tran
GO

--Sửa thành viên
CREATE PROC sp_SuaKhach
	@matv int,
	@tentv nvarchar(100),
	@cmnd varchar(20),
	@ngay_sinh date,
	@dia_chi nvarchar(100),
	@chinhanhdk int,
	@email nvarchar(100)
AS
BEGIN TRAN
	BEGIN TRY
		IF((@matv is null) or (@tentv IS NULL) OR (@cmnd IS NULL) OR (@ngay_sinh IS NULL) OR (@dia_chi IS NULL) OR (@chinhanhdk IS NULL) OR (@email IS NULL))
		BEGIN
			PRINT('lỗi thiếu thông tin')
			rollback tran
			return
		END
		IF(EXISTS(SELECT*FROM THANHVIEN WHERE @cmnd = CMND and @matv != MATV))
		BEGIN
			PRINT'Đã có thành viên này nên không được sửa'
			rollback tran
			return 
		END
		IF(NOT EXISTS(SELECT*FROM CHINHANH WHERE @chinhanhdk = MACN))
		BEGIN
			PRINT'Không có chi nhánh này'
			rollback tran
			return 
		END
	END TRY 
	BEGIN CATCH
		PRINT'Lỗi sửa khách'
		rollback tran
	END CATCH
	UPDATE THANHVIEN SET TENTV = @tentv,CMND = @cmnd, NGAYSINH = @ngay_sinh,DIACHI = @dia_chi,CHINHANHDK = @chinhanhdk,EMAIL = @email
	WHERE MATV = @matv
	print'sửa thành công'
commit tran
GO

--Xóa thành viên
CREATE PROC sp_XoaKhach
	@matv int
AS
BEGIN TRAN
	BEGIN TRY
		IF(@matv is null)
		BEGIN
			PRINT('lỗi thiếu thông tin')
			rollback tran
			return
		END
		IF(NOT EXISTS(SELECT*FROM THANHVIEN WHERE @matv != MATV))
		BEGIN
			PRINT'Không có thành viên này nên không được xóa'
			rollback tran
			return 
		END
	END TRY 
	BEGIN CATCH
		PRINT'Lỗi xóa khách'
		rollback tran
	END CATCH
	DELETE FROM THANHVIEN WHERE MATV = @matv
	print'xóa thành công'
commit tran
GO

--Thống kê doanh thu theo tháng tổng
CREATE PROC sp_ThongKeTheoThangTong
AS
SELECT MONTH(DH.NGAYDAT) AS THANG,YEAR(DH.NGAYDAT) as NAM, SUM(DH.THANHTIEN) AS DOANH_THU
FROM DONHANG DH
GROUP BY MONTH(DH.NGAYDAT),YEAR(DH.NGAYDAT)
ORDER BY THANG DESC,NAM DESC
GO

--Thống kê doanh thu theo năm tổng
CREATE PROC sp_ThongKeTheoNamTong
AS
SELECT YEAR(DH.NGAYDAT) AS NAM, SUM(CAST(DH.THANHTIEN AS BIGINT)) AS DOANH_THU
FROM DONHANG DH
GROUP BY YEAR(DH.NGAYDAT)
ORDER BY NAM DESC
GO

--Thống kê theo món tổng
CREATE PROC sp_ThongKeTheoMonTong
AS
SELECT M.TENMON, SUM(CAST(CT.SL*M.GIATIEN AS BIGINT)) AS DOANH_THU
FROM CHITIETDONHANG CT, MONAN M,DONHANG DH
WHERE CT.MAMON = M.MAMON AND CT.MADH = DH.MADH 
GROUP BY M.TENMON
ORDER BY DOANH_THU DESC
GO

--Thống kê theo loại món tổng
CREATE PROC sp_ThongKeTheoLoaiMonTong
AS
SELECT L.TENLOAI, SUM(CAST(CT.SL*M.GIATIEN AS BIGINT)) AS DOANH_THU
FROM CHITIETDONHANG CT, MONAN M,LOAIMON L, DONHANG DH
WHERE CT.MAMON = M.MAMON AND M.MALOAI = L.MALOAI AND DH.MADH = CT.MADH
GROUP BY L.TENLOAI
ORDER BY DOANH_THU DESC
GO

--Thống kê theo ngày tổng
CREATE PROC sp_ThongKeTheoNgayTong
AS
SELECT DH.NGAYDAT as NGAY, SUM(DH.THANHTIEN) AS DOANH_THU
FROM DONHANG DH
GROUP BY DH.NGAYDAT
ORDER BY NGAY DESC
GO

--Thống kê theo kênh đặt hàng
CREATE PROC sp_TheoKenhDatHangTong
AS
SELECT DH.KENHDH, SUM(CAST(DH.THANHTIEN AS BIGINT)) AS DOANH_THU
FROM DONHANG DH
GROUP BY DH.KENHDH
ORDER BY DOANH_THU DESC
GO

--Thống kê theo loại khách hàng
CREATE PROC sp_ThongKeTheoLoaiKhachHangTong
AS
SELECT SUM(CAST(DH.THANHTIEN AS BIGINT)) AS KHACHVANGLAI,
		(SELECT SUM(CAST(DH.THANHTIEN AS BIGINT))
		FROM DONHANG DH
		WHERE DH.MATV IS NULL) THANHVIEN
FROM DONHANG DH 
WHERE DH.MATV IS NOT NULL
GO

--Tỉ lệ hủy đơn theo kênh
CREATE PROC sp_TiLeHuyDonTheoKenhTong
AS
BEGIN TRAN
	DECLARE @online int = (SELECT COUNT(*)
							FROM DONHANG DH
							WHERE DH.KENHDH = N'Online')
	IF(@online = 0) SET @online = 1
	DECLARE @dt int = (SELECT COUNT(*)
							FROM DONHANG DH
							WHERE DH.KENHDH = N'Điện thoại')
	IF(@dt = 0) SET @dt = 1
	DECLARE @tt int = (SELECT COUNT(*)
							FROM DONHANG DH
							WHERE DH.KENHDH = N'Trực tiếp')
	IF(@tt = 0) SET @tt = 1
	SELECT COUNT(*)*100/@online as TiLeHuyOnline, (SELECT COUNT(*)*100/@dt
											FROM DONHANG DH
											WHERE DH.KENHDH = N'Điện thoại'AND DH.HUYDON = 1) TiLeHuyDienThoai
										,(SELECT COUNT(*)*100/@tt
											FROM DONHANG DH
											WHERE DH.KENHDH = N'Trực tiếp' AND DH.HUYDON = 1) TiLeHuyTrucTiep
	FROM DONHANG DH
	WHERE DH.KENHDH = N'Online' AND DH.HUYDON = 1
commit tran
GO

--Tỉ lệ hủy đơn theo loại khách
CREATE PROC sp_TiLeHuyDonTheoLoaiKHTong
AS
BEGIN TRAN
	DECLARE @khach int = (SELECT COUNT(*)
							FROM DONHANG DH
							WHERE DH.MATV IS NULL)
	IF(@khach = 0) SET @khach = 1
	DECLARE @thanhvien int = (SELECT COUNT(*)
								FROM DONHANG DH
								WHERE DH.MATV IS NOT NULL)
	IF(@thanhvien = 0) SET @thanhvien = 1
	SELECT COUNT(*)*100/@khach as TiLeHuyKhachVangLai, (SELECT COUNT(*)*100/@thanhvien
														FROM DONHANG DH
														WHERE DH.MATV IS NOT NULL AND DH.HUYDON = 1) TiLeHuyThanhVien
	FROM DONHANG DH
	WHERE DH.MATV IS NULL AND DH.HUYDON = 1
commit tran
GO

--Hiện giỏ 
CREATE PROC sp_HienGio @MATK INT
AS
	SELECT M.TENMON,G.SL,M.GIATIEN as GIA1PHAN FROM GIO G,MONAN M WHERE G.MAMON=M.MAMON AND MATK = @MATK
GO

--Thêm giỏ
create proc sp_ThemGio
	@matk int,
	@ma_mon int,
	@ma_cn int,
	@sl int
as
begin tran
	BEGIN TRY
	if ((select count(*)from GIO where @matk = MATK) <> 0 and exists(select * from GIO where @matk = MATK and MACN <>@ma_cn))
	begin
		rollback tran
		return
	end
	END TRY 
	BEGIN CATCH
		rollback tran
	END CATCH
	if exists(select * from GIO where @matk = MATK and @ma_mon = MAMON and @ma_cn = MACN) 
		update GIO set SL = SL + @sl where @matk = MATK and @ma_mon = MAMON and @ma_cn = MACN
	else
		insert into GIO values(@matk,@ma_mon,@ma_cn,@sl)
commit tran
GO

--Xóa giỏ
create proc sp_XoaGio
	@matk varchar(20),
	@ma_mon int,
	@sl int
as
begin tran
	 begin try
		if not exists(select * from gio where @matk = matk and @ma_mon = mamon)
		begin
			print'không xóa được vì không có'
			rollback tran
			return
		end
		if (@sl > (select sl from gio where @matk = matk and @ma_mon = mamon))
		begin
			print'không xóa được vì không đúng sl'
			rollback tran
			return
		end
	end try
	begin catch
		print'lỗi xóa'
		rollback tran
	end catch
	if(@sl != (select sl from gio where @matk = matk and @ma_mon = mamon))
		update gio set sl = sl - @sl where @matk = matk and @ma_mon = mamon
	else
		delete from gio where @matk = matk and @ma_mon = mamon
commit tran
GO

--Hiện đơn hàng cá nhân
CREATE PROC sp_DonHangCaNhan @MATV int
AS
BEGIN TRAN
	SELECT DH.MADH, DH.TRANGTHAI,DH.THANHTIEN
	FROM DONHANG DH
	WHERE DH.MATV=@MATV
	UNION
	SELECT DH.MADH, DH.TRANGTHAI,DH.THANHTIEN
	FROM DONHANG DH,DHTRUCTUYEN DHTT
	WHERE DH.MADH = DHTT.MADH AND DHTT.SDT = CONCAT('0',CAST(@MATV AS varchar(99)))
commit tran
GO

--Update tình trạng đơn hàng
CREATE PROC sp_UpDH @MADH INT,@TRANGTHAI NVARCHAR(100)
AS
BEGIN TRAN
BEGIN TRY
	DECLARE @KENHDH NVARCHAR(100)=(SELECT KENHDH FROM DONHANG WHERE MADH=@MADH)
	IF(EXISTS(SELECT MADH FROM DONHANG WHERE MADH=@MADH))
	BEGIN
		IF((@KENHDH=N'Online')OR(@KENHDH=N'Điện thoại'))
		BEGIN
			IF(@TRANGTHAI IN (N'Tiếp nhận',N'Đang chuẩn bị',N'Đang giao',N'Hoàn tất'))
				UPDATE DONHANG SET TRANGTHAI=@TRANGTHAI WHERE MADH=@MADH
		END
		ELSE
		BEGIN
			IF(@KENHDH=N'Trực tiếp')
			BEGIN
				IF(@TRANGTHAI IN (N'Tiếp nhận',N'Đang chuẩn bị',N'Chờ thanh toán',N'Hoàn tất'))
					UPDATE DONHANG SET TRANGTHAI=@TRANGTHAI WHERE MADH=@MADH
			END
		END	
		
		IF(@TRANGTHAI=N'Hoàn tất')
		BEGIN
			DECLARE @DIEMTL INT,@MATV INT
			SET @MATV=(SELECT MATV FROM DONHANG WHERE MADH=@MADH)
			SET @DIEMTL=(SELECT DIEMTICHLUY FROM THANHVIEN WHERE MATV=@MATV)
			IF(@DIEMTL IS NULL)
				SET @DIEMTL=(SELECT TONGTIEN FROM DONHANG WHERE MADH=@MADH)
			ELSE
				SET @DIEMTL=@DIEMTL+(SELECT TONGTIEN FROM DONHANG WHERE MADH=@MADH)

			IF(@DIEMTL<=5000000)
				UPDATE THANHVIEN SET DIEMTICHLUY=@DIEMTL,LOAITHE='Silver' WHERE MATV=@MATV
			ELSE IF(@DIEMTL>5000000 AND @DIEMTL<=20000000)
				UPDATE THANHVIEN SET DIEMTICHLUY=@DIEMTL,LOAITHE='Gold' WHERE MATV=@MATV
			ELSE IF(@DIEMTL>20000000)
				UPDATE THANHVIEN SET DIEMTICHLUY=@DIEMTL,LOAITHE='Diamond' WHERE MATV=@MATV
		END
		SELECT*FROM DONHANG WHERE MADH=@MADH
	END
	COMMIT TRAN
END TRY
BEGIN CATCH
	ROLLBACK TRAN
END CATCH
GO

--Cập nhât mật khẩu
CREATE PROC sp_UPTHETV3
	@MATV INT,
	@MATKHAU VARCHAR(100),
	@MATKHAUMOI VARCHAR(100)
AS
BEGIN
BEGIN TRAN
	BEGIN TRY
		IF (EXISTS (SELECT MATV FROM dbo.THANHVIEN WHERE MATV = @MATV))
		BEGIN
			IF (EXISTS (SELECT MATKHAU FROM dbo.THANHVIEN WHERE MATV = @MATV))
			BEGIN
				UPDATE dbo.THANHVIEN SET MATKHAU = @MATKHAUMOI WHERE MATV = @MATV AND MATKHAU = @MATKHAU
				--PRINT N'CẬP NHẬT THÔNG TIN THÀNH CÔNG!!!'
			END
		END
		COMMIT
	END TRY
	BEGIN CATCH
		ROLLBACK
	END CATCH
END
GO

--Thêm đơn hàng
CREATE PROC sp_InDH 
	@MANV INT,
	@MATV INT,
	@MACN INT,
	@KENHDH NVARCHAR(100),
	@PTTT NVARCHAR(100)
AS
BEGIN TRAN
BEGIN TRY
	IF(((EXISTS(SELECT MANV FROM NHANVIEN WHERE MANV=@MANV AND MACN=@MACN))OR @MANV IS NULL)AND(EXISTS(SELECT MACN FROM CHINHANH WHERE MACN=@MACN)))
	BEGIN
		DECLARE @MADH INT=(SELECT MAX(MADH) FROM DONHANG)
		IF(@MADH IS NULL)
			SET @MADH=1
		ELSE
			SET @MADH=@MADH+1
		INSERT INTO DONHANG VALUES(@MADH,@MANV,@MATV,@MACN,GETDATE(),N'Tiếp nhận',@KENHDH,0,0,@PTTT,0)
	END
	COMMIT TRAN
END TRY
BEGIN CATCH
	ROLLBACK TRAN
END CATCH
GO

--Thêm đơn trực tuyến
CREATE PROC sp_InDHTT 
	@MADH INT,
	@TENKH NVARCHAR(100),
	@SDT VARCHAR(100),
	@SONHA NVARCHAR(100),
	@PHUONG NVARCHAR(100),
	@QUAN_HUYEN NVARCHAR(100),
	@TINH_TP NVARCHAR(100)
AS
BEGIN TRAN
BEGIN TRY
	IF((EXISTS(SELECT MADH FROM DONHANG WHERE MADH=@MADH AND TRANGTHAI=N'Tiếp nhận'))AND((SELECT KENHDH FROM DONHANG WHERE MADH=@MADH)!=N'Trực tiếp'))
	BEGIN
		DECLARE @NVGIAOHANG INT = (select TOP 1 N.MANV FROM NHANVIEN N,DONHANG D WHERE D.MACN=N.MACN AND D.MADH=@MADH AND N.CHUCVU=N'Nhân viên giao hàng' ORDER BY NEWID())--Chọn random 
		IF(@MADH NOT IN (SELECT MADH FROM DHTRUCTUYEN))--1 đơn hàng chỉ giao 1 lần
		BEGIN
			DECLARE @CHIPHI INT,@TGGIAO TIME,@P NVARCHAR(100),@Q NVARCHAR(100),@TP NVARCHAR(100)
			SET @P=(SELECT PHUONG FROM CHINHANH C,DONHANG D WHERE D.MACN=C.MACN AND D.MADH=@MADH)
			SET @Q=(SELECT QUAN_HUYEN FROM CHINHANH C,DONHANG D WHERE D.MACN=C.MACN AND D.MADH=@MADH)
			SET @TP=(SELECT TINH_TP FROM CHINHANH C,DONHANG D WHERE D.MACN=C.MACN AND D.MADH=@MADH)
				
			IF(@TINH_TP=@TP)
			BEGIN
				IF(@QUAN_HUYEN=@Q)
				BEGIN
					IF(@PHUONG=@P)
						SET @CHIPHI=0
					ELSE
						SET @CHIPHI=20000
				END
				ELSE
					SET @CHIPHI=50000
				SET @TGGIAO=DATEADD(HOUR,3,GETDATE())
				INSERT INTO DHTRUCTUYEN VALUES(@MADH,@NVGIAOHANG,@TENKH,@SDT,@SONHA,@PHUONG,@QUAN_HUYEN,@TINH_TP,@CHIPHI,@TGGIAO)
				DECLARE @TONGTIEN FLOAT =(SELECT TONGTIEN FROM DONHANG WHERE MADH=@MADH)+@CHIPHI
				UPDATE DONHANG SET TRANGTHAI=N'Đang giao',TONGTIEN=@TONGTIEN WHERE MADH=@MADH
			END
		END
	END
	COMMIT TRAN
END TRY
BEGIN CATCH
	ROLLBACK TRAN
END CATCH
GO

--Thêm chi tiết đơn
CREATE PROC sp_InCTDH @MADH INT,@MAMON INT,@SL INT
AS
BEGIN TRAN
BEGIN TRY
	IF(EXISTS(SELECT MADH FROM DONHANG D, THUCDON T WHERE MADH=@MADH AND D.MACN=T.MACN))
	BEGIN
		IF((SELECT SL_CONLAI FROM DONHANG D, THUCDON T WHERE MADH=@MADH AND T.MAMON=@MAMON AND D.MACN=T.MACN AND T.NGAY=CAST(GETDATE() AS DATE))>=@SL)
		BEGIN
			IF((SELECT TRANGTHAI FROM DONHANG WHERE MADH=@MADH)=N'Tiếp nhận')--Trạng thái khác không được tiếp tục thêm món vào đơn
			BEGIN
				DECLARE @THANHTIEN INT,@THANHTIEN_MOI INT,@TONGTIEN FLOAT,@LOAITHE NVARCHAR(100),@TONGTIEN_INS FLOAT
				SET @TONGTIEN=(SELECT TONGTIEN FROM DONHANG WHERE MADH=@MADH)
				SET @LOAITHE=(SELECT T.LOAITHE FROM DONHANG D,THANHVIEN T WHERE D.MADH=@MADH AND D.MATV=T.MATV)
				SET @THANHTIEN=(SELECT THANHTIEN FROM DONHANG WHERE MADH=@MADH)
				SET @THANHTIEN_MOI=(SELECT SUM(GIATIEN*@SL) FROM MONAN WHERE MAMON=@MAMON)
				INSERT INTO CHITIETDONHANG VALUES(@MADH,@MAMON,@SL)
				UPDATE THUCDON SET SL_CONLAI=SL_CONLAI-@SL WHERE MAMON = @MAMON AND MACN=(SELECT MACN FROM DONHANG WHERE MADH = @MADH)AND NGAY=CAST(GETDATE() AS DATE)
				SET @THANHTIEN=@THANHTIEN + @THANHTIEN_MOI
				IF(@LOAITHE='Silver')
					SET @TONGTIEN_INS=@TONGTIEN+@THANHTIEN_MOI
				ELSE IF(@LOAITHE='Gold')
					SET @TONGTIEN_INS=@TONGTIEN+@THANHTIEN_MOI*0.95
				ELSE IF(@LOAITHE='Diamond')
					SET @TONGTIEN_INS=@TONGTIEN+@THANHTIEN_MOI*0.9
				ELSE SET @TONGTIEN_INS=@TONGTIEN+@THANHTIEN_MOI
				UPDATE DONHANG SET THANHTIEN=@THANHTIEN,TONGTIEN=@TONGTIEN_INS WHERE MADH=@MADH
			END
		END
	END
	COMMIT TRAN
END TRY
BEGIN CATCH
	ROLLBACK TRAN
END CATCH
GO

--Xóa CTDH
CREATE PROC sp_DelCTDH @MADH INT,@MAMON INT
AS
BEGIN TRAN
BEGIN TRY
	IF(EXISTS(SELECT MADH,MAMON FROM DONHANG D, THUCDON T WHERE MADH=@MADH AND D.MACN=T.MACN AND T.NGAY=CAST(GETDATE() AS DATE)))
	BEGIN
		DECLARE @THANHTIEN INT,@THANHTIEN_CU INT,@TONGTIEN FLOAT,@LOAITHE NVARCHAR(100),@TONGTIEN_DEL FLOAT,@SL_CU INT
		SET @TONGTIEN=(SELECT TONGTIEN FROM DONHANG WHERE MADH=@MADH)
		SET @LOAITHE=(SELECT LOAITHE FROM DONHANG D,THANHVIEN T WHERE D.MADH=@MADH AND D.MATV=T.MATV)
		SET @THANHTIEN=(SELECT THANHTIEN FROM DONHANG WHERE MADH=@MADH)
		SET @SL_CU=(SELECT SL FROM CHITIETDONHANG WHERE MADH=@MADH AND MAMON=@MAMON)
		SET @THANHTIEN_CU=(SELECT SUM(GIATIEN*@SL_CU) FROM MONAN WHERE MAMON=@MAMON)
				
		DELETE FROM CHITIETDONHANG WHERE MADH=@MADH AND MAMON=@MAMON
		UPDATE THUCDON SET SL_CONLAI=SL_CONLAI+@SL_CU WHERE MAMON = @MAMON AND MACN=(SELECT MACN FROM DONHANG WHERE MADH = @MADH)AND NGAY=CAST(GETDATE() AS DATE)
		SET @THANHTIEN=@THANHTIEN - @THANHTIEN_CU
		
		IF(@LOAITHE='Silver')
			SET @TONGTIEN_DEL=@TONGTIEN-@THANHTIEN_CU
		ELSE IF(@LOAITHE='Gold')
			SET @TONGTIEN_DEL=@TONGTIEN-@THANHTIEN_CU*0.95
		ELSE IF(@LOAITHE='Diamond')
			SET @TONGTIEN_DEL=@TONGTIEN-@THANHTIEN_CU*0.9
		ELSE SET @TONGTIEN_DEL=@TONGTIEN-@THANHTIEN_CU
		UPDATE DONHANG SET THANHTIEN=@THANHTIEN,TONGTIEN=@TONGTIEN_DEL WHERE MADH=@MADH

		IF((SELECT COUNT(*) FROM CHITIETDONHANG WHERE MADH=@MADH)=0)
			UPDATE DONHANG SET TONGTIEN=0,THANHTIEN=0 WHERE MADH=@MADH
	COMMIT TRAN
	END
END TRY
BEGIN CATCH
	ROLLBACK TRAN
END CATCH
GO

--Thêm đơn online từ giỏ
CREATE PROC sp_ThemDonHangOnline
	@MATV INT,
	@MACN INT,
	@PTTT NVARCHAR(100),
	@TENKH NVARCHAR(100),
	@SDT VARCHAR(100),
	@SONHA NVARCHAR(100),
	@PHUONG NVARCHAR(100),
	@QUAN_HUYEN NVARCHAR(100),
	@TINH_TP NVARCHAR(100)
AS
BEGIN TRANSACTION
		EXEC sp_InDH NULL,@MATV,@MACN,N'Online',@PTTT
		DECLARE @MADH INT = (SELECT MAX(MADH)
							FROM DONHANG)
	DECLARE cursorGio CURSOR FOR SELECT MAMON,SL FROM GIO WHERE MATK = @MATV OR MATK = CAST(@SDT as INT)
	OPEN cursorGio
	DECLARE @MAMON INT
	DECLARE @SL INT
	FETCH NEXT FROM cursorGio INTO @MAMON, @SL
	WHILE @@FETCH_STATUS = 0
	BEGIN
		EXEC sp_InCTDH @MADH,@MAMON,@SL
		FETCH NEXT FROM cursorGio INTO @MAMON, @SL
	END
	CLOSE cursorGio
	DEALLOCATE cursorGio
	EXEC sp_InDHTT @MADH,@TENKH,@SDT,@SONHA,@PHUONG,@QUAN_HUYEN,@TINH_TP
	delete from GIO WHERE MATK=@MATV OR MATK = CAST(@SDT as INT)
COMMIT TRAN
GO

--Thêm món
CREATE PROC sp_ThemMon
	@TENMON nvarchar(100),
	@MALOAI int,
	@GiA int
AS
BEGIN TRAN
	BEGIN TRY
		IF ((@TENMON IS NULL) OR (@MALOAI IS NULL) OR (@GiA IS NULL))
		BEGIN
			ROLLBACK TRAN
			RETURN
		END
		IF (NOT EXISTS(SELECT* FROM LOAIMON WHERE @MALOAI = MALOAI))
		BEGIN
			ROLLBACK TRAN
			RETURN
		END
		IF (EXISTS(SELECT* FROM MONAN WHERE @TENMON = TENMON))
		BEGIN
			ROLLBACK TRAN
			RETURN
		END
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN
	END CATCH
	DECLARE @MAMON INT
	SET @MAMON = (SELECT MAMON FROM MONAN WHERE MAMON >= ALL(SELECT MAMON FROM MONAN)) + 1
	IF(@MAMON IS NULL)
		SET @MAMON = 1
	INSERT INTO MONAN VALUES(@MAMON,@TENMON,@MALOAI,@GiA)
COMMIT TRAN
GO

--Xóa món
CREATE PROC sp_XoaMon
	@MAMON int
AS
BEGIN TRAN
	BEGIN TRY
		IF ((@MAMON IS NULL))
		BEGIN
			ROLLBACK TRAN
			RETURN
		END
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN
	END CATCH
	DELETE FROM MONAN WHERE @MAMON = MAMON
COMMIT TRAN
GO

--Sửa món
CREATE PROC sp_SuaMon
	@MAMON INT,
	@GiA int
AS
BEGIN TRAN
	BEGIN TRY
		IF ((@MAMON IS NULL) OR (@GiA IS NULL))
		BEGIN
			ROLLBACK TRAN
			RETURN
		END
		IF (NOT EXISTS(SELECT* FROM MONAN WHERE @MAMON = MAMON))
		BEGIN
			ROLLBACK TRAN
			RETURN
		END
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN
	END CATCH
	UPDATE MONAN SET GIATIEN = @GiA WHERE @MAMON = MAMON
COMMIT TRAN
GO

--Thêm loại món
CREATE PROC sp_ThemLoaiMon
	@TENLOAI nvarchar(100)
AS
BEGIN TRAN
	BEGIN TRY
		IF ((@TENLOAI IS NULL))
		BEGIN
			ROLLBACK TRAN
			RETURN
		END
		IF (EXISTS(SELECT* FROM LOAIMON WHERE @TENLOAI = TENLOAI))
		BEGIN
			ROLLBACK TRAN
			RETURN
		END
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN
	END CATCH
	DECLARE @MALOAI INT
	SET @MALOAI = (SELECT MAX(MALOAI) FROM LOAIMON) + 1
	IF(@MALOAI IS NULL)
		SET @MALOAI = 1
	INSERT INTO LOAIMON VALUES(@MALOAI,@TENLOAI)
COMMIT TRAN
GO

--Xóa loại món
CREATE PROC sp_XoaLoaiMon
	@MALOAI INT
AS
BEGIN TRAN
	BEGIN TRY
		IF ((@MALOAI IS NULL))
		BEGIN
			ROLLBACK TRAN
			RETURN
		END
		IF (NOT EXISTS(SELECT* FROM LOAIMON WHERE @MALOAI = MALOAI))
		BEGIN
			ROLLBACK TRAN
			RETURN
		END
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN
	END CATCH
	DELETE FROM LOAIMON WHERE @MALOAI = MALOAI
COMMIT TRAN
GO

--Ds trạng thái đơn
CREATE PROC sp_TinhTrangDon
AS
	SELECT MADH,TRANGTHAI FROM DONHANG
GO

--KHÁCH HOẶC NHÂN VIÊN HỦY ĐƠN 
CREATE PROC sp_UpDH_HuyDon @MADH INT
AS
BEGIN TRAN
	IF(EXISTS(SELECT MADH FROM DONHANG WHERE MADH=@MADH AND TRANGTHAI =N'Tiếp nhận'))
	BEGIN
			UPDATE DONHANG SET TRANGTHAI=N'Đã hủy',HUYDON=1 WHERE MADH=@MADH
			DECLARE @NGAY DATE=(SELECT NGAYDAT FROM DONHANG WHERE MADH=@MADH)
			DECLARE @MACN INT=(SELECT MACN FROM DONHANG WHERE MADH=@MADH)
			DECLARE cursorHuy CURSOR FOR SELECT MAMON,SL FROM CHITIETDONHANG WHERE MADH=@MADH
			OPEN cursorHuy
			DECLARE @MAMON INT
			DECLARE @SL INT
			FETCH NEXT FROM cursorHuy INTO @MAMON, @SL
			WHILE @@FETCH_STATUS = 0
			BEGIN
				UPDATE dbo.THUCDON SET SL_CONLAI=SL_CONLAI+ @SL WHERE MACN=@MACN AND MAMON=@MAMON AND NGAY=@NGAY
				DELETE FROM dbo.CHITIETDONHANG WHERE MADH=@MADH AND MAMON=@MAMON
				FETCH NEXT FROM cursorHuy INTO @MAMON, @SL
			END
			CLOSE cursorHuy
			DEALLOCATE cursorHuy
	END
COMMIT TRAN
GO

--Thêm thực đơn
CREATE PROC sp_ThemMonThucDon
	@MACN int,
	@MAMON int,
	@NGAY date,
	@SOLUONG int,
	@SL_CON int
AS
BEGIN TRAN
	BEGIN TRY
		IF ((@MACN IS NULL) OR (@MAMON IS NULL) OR (@SOLUONG IS NULL) OR (@SL_CON IS NULL) OR (@NGAY IS NULL))
		BEGIN
			ROLLBACK TRAN
		END
		IF NOT EXISTS(SELECT * FROM CHINHANH WHERE @MACN = MACN)
		BEGIN
			ROLLBACK TRAN
		END
		IF NOT EXISTS(SELECT * FROM MONAN WHERE @MAMON = MAMON)
		BEGIN
			ROLLBACK TRAN
		END
		IF EXISTS(SELECT * FROM THUCDON WHERE @MAMON = MAMON AND @MACN = MACN AND @NGAY = NGAY)
		BEGIN
			ROLLBACK TRAN
		END
		IF (@SL_CON > @SOLUONG)
		BEGIN
			ROLLBACK TRAN
		END
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN
	END CATCH
	INSERT INTO THUCDON VALUES(@MACN,@MAMON,@NGAY,@SOLUONG,@SL_CON)
COMMIT TRAN
GO

--Xóa thực đơn
CREATE PROC sp_XoaMonThucDon
	@MACN int,
	@MAMON int,
	@NGAY date
AS
BEGIN TRAN
	BEGIN TRY
		IF (NOT EXISTS(SELECT * FROM THUCDON WHERE @MACN = MACN AND @MAMON = MAMON AND @NGAY = NGAY))
		BEGIN
			PRINT'Không có món ăn này trong thực đơn'
			ROLLBACK TRAN
			RETURN 0
		END
	END TRY
	BEGIN CATCH
		PRINT'Lỗi Xóa thực đơn'
		ROLLBACK TRAN
	END CATCH
	DELETE FROM THUCDON WHERE @MACN = MACN AND @MAMON = MAMON AND NGAY = @NGAY
	PRINT'Xóa thành công'
COMMIT TRAN
GO